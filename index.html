<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>كادو — نظام المحاسبة</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
<style>
  :root{--teal:#008080;--teal-dark:#004d40;--bg:#f7fdfc;--card:#e0f2f1}
  *{box-sizing:border-box;font-family:'Cairo',sans-serif}
  body{margin:0;background:var(--bg);color:var(--teal-dark);min-height:100vh;display:flex;flex-direction:column;align-items:stretch}
  header{background:linear-gradient(90deg,var(--teal) 0%, #009688cc 100%);color:#fff;padding:16px;text-align:center}
  header h1{margin:0;font-size:20px}
  .container{max-width:1200px;margin:18px auto;padding:12px;width:95%}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:14px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:220px}
  label{display:block;margin-bottom:6px;font-weight:700}
  input[type=text], input[type=number], input[type=password], select, textarea{
    width:100%;padding:10px;border:1px solid #004d40;border-radius:6px;background:#fff
  }
  button{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn-teal{background:var(--teal);color:#fff}
  .btn-green{background:#25D366;color:#fff}
  .btn-red{background:#d32f2f;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff;border-radius:8px;overflow:hidden}
  th, td{padding:8px;text-align:center;border-bottom:1px solid #e0e0e0;font-size:14px}
  th{background:var(--teal);color:#fff;position:sticky;top:0}
  .small{font-size:13px;color:#063}
  .muted{color:#555;font-size:13px}
  .actions button{margin:0 4px;padding:6px 8px;border-radius:6px}
  .hidden{display:none}
  .loginBox{max-width:420px;margin:40px auto}
  .center{text-align:center}
  @media(max-width:820px){ .row{flex-direction:column} th, td{font-size:12px} }
</style>
</head>
<body>

<header>
  <h1>كادو — نظام المحاسبة الداخلية</h1>
</header>

<div class="container">

  <!-- صفحة الدخول -->
  <div id="loginPage" class="card loginBox">
    <h2 class="center">تسجيل الدخول</h2>
    <form id="loginForm">
      <label>اسم المستخدم</label>
      <input id="loginUser" type="text" required placeholder="مثال: hassan" />
      <label>كلمة المرور</label>
      <input id="loginPass" type="password" required placeholder="********" />
      <div style="margin-top:10px;display:flex;gap:8px">
        <button type="submit" class="btn-teal" style="flex:1">دخول</button>
        <button type="button" id="demoFill" style="flex:1;background:#ffc107;border-radius:8px">تعبئة تجريبية</button>
      </div>
      <p class="muted center" style="margin-top:8px">حسابان جاهزان: <strong>hassan / 1234</strong> و <strong>partner / abcd</strong></p>
    </form>
  </div>

  <!-- المحتوى الرئيسي -->
  <div id="mainApp" class="hidden">

    <div class="card row" style="align-items:center">
      <div class="col">
        <h3>مرحباً، <span id="currentUser" style="color:var(--teal-dark)"></span></h3>
        <div class="muted">كل المستخدمين يرون كل العمليات؛ يمكنك تعديل/حذف ما أدخلته فقط.</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-red" onclick="logout()">تسجيل خروج</button>
      </div>
    </div>

    <!-- إضافة عملية -->
    <div class="card">
      <h3>إضافة عملية جديدة</h3>
      <form id="addForm" class="row">
        <div class="col">
          <label>نوع العملية</label>
          <select id="type" required>
            <option value="">اختر</option>
            <option value="بيع">بيع</option>
            <option value="شراء مواد">شراء مواد</option>
            <option value="صرف">صرف</option>
          </select>
        </div>
        <div class="col">
          <label>المنتج / البند</label>
          <input id="item" type="text" placeholder="مثال: كعك صغير" required />
        </div>
        <div class="col">
          <label>الكمية</label>
          <input id="quantity" type="number" min="1" value="1" required />
        </div>
        <div class="col">
          <label>السعر (للواحد أو للمبلغ)</label>
          <input id="price" type="number" min="0" value="0" required />
        </div>
        <div class="col" style="min-width:100%">
          <label>ملاحظات (اختياري)</label>
          <textarea id="notes" rows="2" placeholder="ملاحظة..."></textarea>
        </div>
        <div style="min-width:180px">
          <label>&nbsp;</label>
          <button type="submit" class="btn-teal" style="width:100%">أضف العملية</button>
        </div>
      </form>
    </div>

    <!-- ملخص و تحكم بالتقارير -->
    <div class="card">
      <div class="row" style="align-items:center">
        <div class="col">
          <h3>ملخص سريع</h3>
          <div id="summaryArea" class="muted">جارٍ حساب الملخص...</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn-green" onclick="prepareAndSendReport('daily')">إرسال التقرير اليومي عبر WhatsApp</button>
            <button class="btn-green" onclick="prepareAndSendReport('weekly')">إرسال التقرير الأسبوعي عبر WhatsApp</button>
            <button class="btn-green" onclick="prepareAndSendReport('monthly')">إرسال التقرير الشهري عبر WhatsApp</button>
          </div>
          <div style="border-left:1px dashed #008080;padding-left:12px;margin-left:12px">
            <div class="muted">إرسال افتراضي إلى رقمك:</div>
            <div class="small"><strong>07702684155</strong></div>
            <div class="muted small">يمكنك إدخال رقم آخر عند الطلب</div>
          </div>
        </div>
      </div>
    </div>

    <!-- جدول العمليات -->
    <div class="card">
      <h3>جميع العمليات</h3>
      <div style="overflow:auto">
        <table id="opsTable">
          <thead>
            <tr>
              <th>الوقت</th>
              <th>المستخدم</th>
              <th>النوع</th>
              <th>البند</th>
              <th>كمية</th>
              <th>سعر</th>
              <th>المجموع</th>
              <th>ملاحظات</th>
              <th>تعديل</th>
              <th>حذف</th>
            </tr>
          </thead>
          <tbody id="opsBody"></tbody>
        </table>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn-teal" onclick="exportCSV()">تصدير CSV</button>
        <button class="btn-teal" onclick="clearAll()" style="background:#ff7043">حذف كل البيانات</button>
      </div>
    </div>

  </div>
</div>

<script>
/* ---------------------------
   إعداد المستخدمين الافتراضيين
   يمكنك تعديل الأسماء/كلمات المرور هنا
   --------------------------- */
const USERS = [
  {username:'hassan', password:'1234'},
  {username:'partner', password:'abcd'}
];

/* رقمك الافتراضي لإرسال واتساب (بدون صفر بداية البلد) */
const DEFAULT_WHATSAPP = '9647702684155'; // العراق +964 then number without leading zero

/* اسم المفتاح في localStorage */
const STORAGE_KEY = 'kado_ops_v1';

/* حالة التطبيق */
let currentUser = null;
let operations = loadOps();

/* --- وظائف التخزين --- */
function loadOps(){
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  } catch(e) {
    return [];
  }
}
function saveOps(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(operations));
}

/* --- صفحة تسجيل الدخول --- */
const loginForm = document.getElementById('loginForm');
const loginPage = document.getElementById('loginPage');
const mainApp = document.getElementById('mainApp');
const currentUserSpan = document.getElementById('currentUser');

loginForm.addEventListener('submit', e=>{
  e.preventDefault();
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  const found = USERS.find(x=>x.username===u && x.password===p);
  if(!found){ alert('اسم المستخدم أو كلمة المرور غير صحيح'); return; }
  currentUser = found.username;
  loginPage.classList.add('hidden');
  mainApp.classList.remove('hidden');
  currentUserSpan.textContent = currentUser;
  renderTable();
  updateSummary();
});

/* زر تعبئة تجريبي لإضافة بعض البيانات السريعة */
document.getElementById('demoFill').addEventListener('click', ()=>{
  if(!confirm('إضافة بيانات تجريبية؟')) return;
  operations.push(
    {id:Date.now()+1, user:'hassan', datetime:new Date().toISOString(), type:'بيع', item:'كعك صغير', quantity:10, price:5000, notes:''},
    {id:Date.now()+2, user:'partner', datetime:new Date().toISOString(), type:'شراء مواد', item:'طحين 25كغ', quantity:1, price:60000, notes:'للمخزون'},
    {id:Date.now()+3, user:'hassan', datetime:new Date().toISOString(), type:'صرف', item:'غاز', quantity:1, price:15000, notes:'صرف يومي'}
  );
  saveOps();
  alert('تمت إضافة بيانات تجريبية');
});

/* تسجيل خروج */
function logout(){
  if(!confirm('هل تريد تسجيل الخروج؟')) return;
  currentUser = null;
  loginPage.classList.remove('hidden');
  mainApp.classList.add('hidden');
  document.getElementById('loginForm').reset();
}

/* --- إضافة عملية --- */
document.getElementById('addForm').addEventListener('submit', function(e){
  e.preventDefault();
  if(!currentUser){ alert('يجب تسجيل الدخول'); return; }
  const type = document.getElementById('type').value;
  const item = document.getElementById('item').value.trim();
  const quantity = parseInt(document.getElementById('quantity').value) || 0;
  const price = parseFloat(document.getElementById('price').value) || 0;
  const notes = document.getElementById('notes').value.trim();
  if(!type || !item || quantity<=0 || price<0){ alert('تأكد من إدخال الحقول المطلوبة'); return; }
  const op = {
    id: Date.now() + Math.floor(Math.random()*999),
    user: currentUser,
    datetime: new Date().toISOString(),
    type, item, quantity, price, notes
  };
  operations.unshift(op); // الأحدث أولاً
  saveOps();
  this.reset();
  renderTable();
  updateSummary();
});

/* --- عرض الجدول --- */
function renderTable(){
  const tbody = document.getElementById('opsBody');
  tbody.innerHTML = '';
  if(operations.length===0){
    tbody.innerHTML = `<tr><td colspan="10" class="muted">لا توجد عمليات مسجلة بعد</td></tr>`;
    return;
  }
  operations.forEach(op=>{
    const sum = (op.quantity * op.price) || 0;
    const dateStr = new Date(op.datetime).toLocaleString('ar-EG');
    const canModify = (op.user === currentUser);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${dateStr}</td>
      <td>${escapeHtml(op.user)}</td>
      <td>${escapeHtml(op.type)}</td>
      <td>${escapeHtml(op.item)}</td>
      <td>${op.quantity}</td>
      <td>${formatNumber(op.price)}</td>
      <td>${formatNumber(sum)}</td>
      <td>${escapeHtml(op.notes||'')}</td>
      <td>${canModify?'<button class="edit" onclick="editOp('+op.id+')">✏️</button>':''}</td>
      <td>${canModify?'<button class="del" onclick="deleteOp('+op.id+')">🗑️</button>':''}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* حماية: هروب نصي بسيط لمنع كسر الجدول */
function escapeHtml(text){
  return String(text).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
}
function formatNumber(n){ return (Math.round(n)||0).toLocaleString('en-US'); }

/* --- تعديل عملية (متاح فقط لصاحبها) --- */
function editOp(id){
  const op = operations.find(o=>o.id===id);
  if(!op) return alert('العملية غير موجودة');
  if(op.user !== currentUser) return alert('لا يمكنك تعديل هذه العملية');
  const newType = prompt('نوع العملية:', op.type);
  if(!newType) return;
  const newItem = prompt('البند / المنتج:', op.item);
  if(!newItem) return;
  const newQty = prompt('الكمية:', op.quantity);
  const newPrice = prompt('السعر:', op.price);
  const newNotes = prompt('ملاحظات:', op.notes || '');
  // تحقق أساسي
  const q = parseInt(newQty); const p = parseFloat(newPrice);
  if(isNaN(q) || isNaN(p) || q<=0 || p<0){ alert('قيمة غير صحيحة للكمية أو السعر'); return; }
  op.type = newType; op.item = newItem; op.quantity = q; op.price = p; op.notes = newNotes;
  saveOps(); renderTable(); updateSummary();
}

/* --- حذف عملية (متاح فقط لصاحبها) --- */
function deleteOp(id){
  const op = operations.find(o=>o.id===id);
  if(!op) return;
  if(op.user !== currentUser) return alert('لا يمكنك حذف هذه العملية');
  if(!confirm('هل تريد حذف هذه العملية نهائياً؟')) return;
  operations = operations.filter(o=>o.id!==id);
  saveOps(); renderTable(); updateSummary();
}

/* --- إحصاءات وملخصات --- */
function updateSummary(){
  const total = { sell:0, buy:0, expense:0 };
  operations.forEach(op=>{
    const sum = (op.quantity*op.price) || 0;
    if(op.type === 'بيع') total.sell += sum;
    else if(op.type === 'شراء مواد') total.buy += sum;
    else if(op.type === 'صرف') total.expense += sum;
  });
  const net = total.sell - (total.buy + total.expense);
  document.getElementById('summaryArea').innerHTML = `
    إجمالي المبيعات: <strong>${formatNumber(total.sell)} د.ع</strong><br>
    إجمالي شراء المواد: <strong>${formatNumber(total.buy)} د.ع</strong><br>
    إجمالي المصروفات: <strong>${formatNumber(total.expense)} د.ع</strong><br>
    <strong>صافي الربح: ${formatNumber(net)} د.ع</strong>
  `;
}

/* --- إنشاء تقارير (دالي — ويكلي — مانثلي) --- */
function prepareAndSendReport(range){
  if(!currentUser) return alert('يجب تسجيل الدخول');
  const now = new Date();
  let from, to = now;
  if(range === 'daily'){
    from = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0);
  } else if(range === 'weekly'){
    const day = now.getDay(); // 0..6 (الأحد=0)
    const diff = day; // بداية الأسبوع: الأحد
    from = new Date(now.getFullYear(), now.getMonth(), now.getDate()-diff, 0,0,0);
  } else if(range === 'monthly'){
    from = new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0);
  } else {
    alert('نطاق غير معروف'); return;
  }
  const filtered = operations.filter(op=>{
    const d = new Date(op.datetime);
    return d >= from && d <= to;
  });
  if(filtered.length === 0) return alert('لا توجد عمليات في هذا النطاق');
  // بناء النص
  const humanRange = range==='daily'?'اليومي': range==='weekly'?'الأسبوعي':'الشهري';
  const dateLabel = (new Date()).toLocaleDateString('ar-EG');
  let message = `📋 تقرير ${humanRange} (${dateLabel})\n\n`;
  let totalSell=0, totalBuy=0, totalExpense=0;
  filtered.forEach(op=>{
    const sum = (op.quantity*op.price) || 0;
    message += `- ${op.type} | ${op.item} x ${op.quantity} = ${sum} د.ع | بواسطة: ${op.user}\n`;
    if(op.type==='بيع') totalSell+=sum;
    else if(op.type==='شراء مواد') totalBuy+=sum;
    else if(op.type==='صرف') totalExpense+=sum;
  });
  const net = totalSell - (totalBuy + totalExpense);
  message += `\nإجمالي المبيعات: ${totalSell} د.ع\nإجمالي شراء المواد: ${totalBuy} د.ع\nإجمالي المصروفات: ${totalExpense} د.ع\nصافي الربح: ${net} د.ع`;
  // افتراضيًا نفتح واتساب لرقم صاحب الحساب. نمنح خيار إرسال لرقم آخر.
  const sendTo = confirm('إرسال إلى رقمك (07702684155)؟ اضغط "إلغاء" لإدخال رقم آخر') ? DEFAULT_WHATSAPP : prompt('أدخل رقم الواتساب بالتنسيق الدولي بدون زائد (+)، مثال: 9647702684155');
  if(!sendTo) return;
  const waLink = `https://wa.me/${sendTo}?text=${encodeURIComponent(message)}`;
  window.open(waLink, '_blank');
}

/* --- تصدير CSV --- */
function exportCSV(){
  if(operations.length===0) return alert('لا توجد بيانات للتصدير');
  const rows = [['id','datetime','user','type','item','quantity','price','sum','notes']];
  operations.forEach(op=>{
    const sum = (op.quantity*op.price) || 0;
    rows.push([op.id, op.datetime, op.user, op.type, op.item, op.quantity, op.price, sum, (op.notes||'')]);
  });
  const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'kado-operations.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* --- مسح كل البيانات (احذر) --- */
function clearAll(){
  if(!confirm('سيتم حذف كل البيانات نهائياً. هل أنت متأكد؟')) return;
  operations = [];
  saveOps();
  renderTable();
  updateSummary();
  alert('تم حذف كل البيانات');
}

/* --- مساعدة: تحميل الصفحة الأولية --- */
document.addEventListener('DOMContentLoaded', ()=>{
  // إذا كان هناك عمليات سابقة، يتم تحميلها. سنعرضها فقط بعد تسجيل الدخول.
  renderTable();
  updateSummary();
});

/* --- مساعدة رقمية: هروب بسيط للخطر XSS عند الطباعة في prompt --- */
window.escapeHtml = escapeHtml;
</script>

</body>
</html>
