<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ÙƒØ§Ø¯Ùˆ â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
<style>
  :root{--teal:#008080;--teal-dark:#004d40;--bg:#f7fdfc;--card:#e0f2f1}
  *{box-sizing:border-box;font-family:'Cairo',sans-serif}
  body{margin:0;background:var(--bg);color:var(--teal-dark);min-height:100vh;display:flex;flex-direction:column;align-items:stretch}
  header{background:linear-gradient(90deg,var(--teal) 0%, #009688cc 100%);color:#fff;padding:16px;text-align:center}
  header h1{margin:0;font-size:20px}
  .container{max-width:1200px;margin:18px auto;padding:12px;width:95%}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:14px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:220px}
  label{display:block;margin-bottom:6px;font-weight:700}
  input[type=text], input[type=number], input[type=password], select, textarea{
    width:100%;padding:10px;border:1px solid #004d40;border-radius:6px;background:#fff
  }
  button{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn-teal{background:var(--teal);color:#fff}
  .btn-green{background:#25D366;color:#fff}
  .btn-red{background:#d32f2f;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff;border-radius:8px;overflow:hidden}
  th, td{padding:8px;text-align:center;border-bottom:1px solid #e0e0e0;font-size:14px}
  th{background:var(--teal);color:#fff;position:sticky;top:0}
  .small{font-size:13px;color:#063}
  .muted{color:#555;font-size:13px}
  .actions button{margin:0 4px;padding:6px 8px;border-radius:6px}
  .hidden{display:none}
  .loginBox{max-width:420px;margin:40px auto}
  .center{text-align:center}
  @media(max-width:820px){ .row{flex-direction:column} th, td{font-size:12px} }
</style>
</head>
<body>

<header>
  <h1>ÙƒØ§Ø¯Ùˆ â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</h1>
</header>

<div class="container">

  <!-- ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginPage" class="card loginBox">
    <h2 class="center">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <form id="loginForm">
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
      <input id="loginUser" type="text" required placeholder="Ù…Ø«Ø§Ù„: hassan" />
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input id="loginPass" type="password" required placeholder="********" />
      <div style="margin-top:10px;display:flex;gap:8px">
        <button type="submit" class="btn-teal" style="flex:1">Ø¯Ø®ÙˆÙ„</button>
        <button type="button" id="demoFill" style="flex:1;background:#ffc107;border-radius:8px">ØªØ¹Ø¨Ø¦Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
      </div>
      <p class="muted center" style="margin-top:8px">Ø­Ø³Ø§Ø¨Ø§Ù† Ø¬Ø§Ù‡Ø²Ø§Ù†: <strong>hassan / 1234</strong> Ùˆ <strong>partner / abcd</strong></p>
    </form>
  </div>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <div id="mainApp" class="hidden">

    <div class="card row" style="align-items:center">
      <div class="col">
        <h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="currentUser" style="color:var(--teal-dark)"></span></h3>
        <div class="muted">ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙŠØ±ÙˆÙ† ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§ØªØ› ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ù…Ø§ Ø£Ø¯Ø®Ù„ØªÙ‡ ÙÙ‚Ø·.</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-red" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© -->
    <div class="card">
      <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
      <form id="addForm" class="row">
        <div class="col">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
          <select id="type" required>
            <option value="">Ø§Ø®ØªØ±</option>
            <option value="Ø¨ÙŠØ¹">Ø¨ÙŠØ¹</option>
            <option value="Ø´Ø±Ø§Ø¡ Ù…ÙˆØ§Ø¯">Ø´Ø±Ø§Ø¡ Ù…ÙˆØ§Ø¯</option>
            <option value="ØµØ±Ù">ØµØ±Ù</option>
          </select>
        </div>
        <div class="col">
          <label>Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„Ø¨Ù†Ø¯</label>
          <input id="item" type="text" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ¹Ùƒ ØµØºÙŠØ±" required />
        </div>
        <div class="col">
          <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
          <input id="quantity" type="number" min="1" value="1" required />
        </div>
        <div class="col">
          <label>Ø§Ù„Ø³Ø¹Ø± (Ù„Ù„ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ù„Ù„Ù…Ø¨Ù„Øº)</label>
          <input id="price" type="number" min="0" value="0" required />
        </div>
        <div class="col" style="min-width:100%">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="notes" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©..."></textarea>
        </div>
        <div style="min-width:180px">
          <label>&nbsp;</label>
          <button type="submit" class="btn-teal" style="width:100%">Ø£Ø¶Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
        </div>
      </form>
    </div>

    <!-- Ù…Ù„Ø®Øµ Ùˆ ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
    <div class="card">
      <div class="row" style="align-items:center">
        <div class="col">
          <h3>Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h3>
          <div id="summaryArea" class="muted">Ø¬Ø§Ø±Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„Ø®Øµ...</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn-green" onclick="prepareAndSendReport('daily')">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¹Ø¨Ø± WhatsApp</button>
            <button class="btn-green" onclick="prepareAndSendReport('weekly')">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø¹Ø¨Ø± WhatsApp</button>
            <button class="btn-green" onclick="prepareAndSendReport('monthly')">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¹Ø¨Ø± WhatsApp</button>
          </div>
          <div style="border-left:1px dashed #008080;padding-left:12px;margin-left:12px">
            <div class="muted">Ø¥Ø±Ø³Ø§Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ù„Ù‰ Ø±Ù‚Ù…Ùƒ:</div>
            <div class="small"><strong>07702684155</strong></div>
            <div class="muted small">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¢Ø®Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
    <div class="card">
      <h3>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
      <div style="overflow:auto">
        <table id="opsTable">
          <thead>
            <tr>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>Ø§Ù„Ù†ÙˆØ¹</th>
              <th>Ø§Ù„Ø¨Ù†Ø¯</th>
              <th>ÙƒÙ…ÙŠØ©</th>
              <th>Ø³Ø¹Ø±</th>
              <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              <th>ØªØ¹Ø¯ÙŠÙ„</th>
              <th>Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="opsBody"></tbody>
        </table>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn-teal" onclick="exportCSV()">ØªØµØ¯ÙŠØ± CSV</button>
        <button class="btn-teal" onclick="clearAll()" style="background:#ff7043">Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
    </div>

  </div>
</div>

<script>
/* ---------------------------
   Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†
   ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡/ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù‡Ù†Ø§
   --------------------------- */
const USERS = [
  {username:'hassan', password:'1234'},
  {username:'partner', password:'abcd'}
];

/* Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† ØµÙØ± Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¨Ù„Ø¯) */
const DEFAULT_WHATSAPP = '9647702684155'; // Ø§Ù„Ø¹Ø±Ø§Ù‚ +964 then number without leading zero

/* Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙŠ localStorage */
const STORAGE_KEY = 'kado_ops_v1';

/* Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
let currentUser = null;
let operations = loadOps();

/* --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ®Ø²ÙŠÙ† --- */
function loadOps(){
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  } catch(e) {
    return [];
  }
}
function saveOps(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(operations));
}

/* --- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
const loginForm = document.getElementById('loginForm');
const loginPage = document.getElementById('loginPage');
const mainApp = document.getElementById('mainApp');
const currentUserSpan = document.getElementById('currentUser');

loginForm.addEventListener('submit', e=>{
  e.preventDefault();
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  const found = USERS.find(x=>x.username===u && x.password===p);
  if(!found){ alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­'); return; }
  currentUser = found.username;
  loginPage.classList.add('hidden');
  mainApp.classList.remove('hidden');
  currentUserSpan.textContent = currentUser;
  renderTable();
  updateSummary();
});

/* Ø²Ø± ØªØ¹Ø¨Ø¦Ø© ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */
document.getElementById('demoFill').addEventListener('click', ()=>{
  if(!confirm('Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©ØŸ')) return;
  operations.push(
    {id:Date.now()+1, user:'hassan', datetime:new Date().toISOString(), type:'Ø¨ÙŠØ¹', item:'ÙƒØ¹Ùƒ ØµØºÙŠØ±', quantity:10, price:5000, notes:''},
    {id:Date.now()+2, user:'partner', datetime:new Date().toISOString(), type:'Ø´Ø±Ø§Ø¡ Ù…ÙˆØ§Ø¯', item:'Ø·Ø­ÙŠÙ† 25ÙƒØº', quantity:1, price:60000, notes:'Ù„Ù„Ù…Ø®Ø²ÙˆÙ†'},
    {id:Date.now()+3, user:'hassan', datetime:new Date().toISOString(), type:'ØµØ±Ù', item:'ØºØ§Ø²', quantity:1, price:15000, notes:'ØµØ±Ù ÙŠÙˆÙ…ÙŠ'}
  );
  saveOps();
  alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
});

/* ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ */
function logout(){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) return;
  currentUser = null;
  loginPage.classList.remove('hidden');
  mainApp.classList.add('hidden');
  document.getElementById('loginForm').reset();
}

/* --- Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© --- */
document.getElementById('addForm').addEventListener('submit', function(e){
  e.preventDefault();
  if(!currentUser){ alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); return; }
  const type = document.getElementById('type').value;
  const item = document.getElementById('item').value.trim();
  const quantity = parseInt(document.getElementById('quantity').value) || 0;
  const price = parseFloat(document.getElementById('price').value) || 0;
  const notes = document.getElementById('notes').value.trim();
  if(!type || !item || quantity<=0 || price<0){ alert('ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'); return; }
  const op = {
    id: Date.now() + Math.floor(Math.random()*999),
    user: currentUser,
    datetime: new Date().toISOString(),
    type, item, quantity, price, notes
  };
  operations.unshift(op); // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
  saveOps();
  this.reset();
  renderTable();
  updateSummary();
});

/* --- Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ --- */
function renderTable(){
  const tbody = document.getElementById('opsBody');
  tbody.innerHTML = '';
  if(operations.length===0){
    tbody.innerHTML = `<tr><td colspan="10" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</td></tr>`;
    return;
  }
  operations.forEach(op=>{
    const sum = (op.quantity * op.price) || 0;
    const dateStr = new Date(op.datetime).toLocaleString('ar-EG');
    const canModify = (op.user === currentUser);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${dateStr}</td>
      <td>${escapeHtml(op.user)}</td>
      <td>${escapeHtml(op.type)}</td>
      <td>${escapeHtml(op.item)}</td>
      <td>${op.quantity}</td>
      <td>${formatNumber(op.price)}</td>
      <td>${formatNumber(sum)}</td>
      <td>${escapeHtml(op.notes||'')}</td>
      <td>${canModify?'<button class="edit" onclick="editOp('+op.id+')">âœï¸</button>':''}</td>
      <td>${canModify?'<button class="del" onclick="deleteOp('+op.id+')">ğŸ—‘ï¸</button>':''}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* Ø­Ù…Ø§ÙŠØ©: Ù‡Ø±ÙˆØ¨ Ù†ØµÙŠ Ø¨Ø³ÙŠØ· Ù„Ù…Ù†Ø¹ ÙƒØ³Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
function escapeHtml(text){
  return String(text).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
}
function formatNumber(n){ return (Math.round(n)||0).toLocaleString('en-US'); }

/* --- ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© (Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„ØµØ§Ø­Ø¨Ù‡Ø§) --- */
function editOp(id){
  const op = operations.find(o=>o.id===id);
  if(!op) return alert('Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
  if(op.user !== currentUser) return alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
  const newType = prompt('Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:', op.type);
  if(!newType) return;
  const newItem = prompt('Ø§Ù„Ø¨Ù†Ø¯ / Ø§Ù„Ù…Ù†ØªØ¬:', op.item);
  if(!newItem) return;
  const newQty = prompt('Ø§Ù„ÙƒÙ…ÙŠØ©:', op.quantity);
  const newPrice = prompt('Ø§Ù„Ø³Ø¹Ø±:', op.price);
  const newNotes = prompt('Ù…Ù„Ø§Ø­Ø¸Ø§Øª:', op.notes || '');
  // ØªØ­Ù‚Ù‚ Ø£Ø³Ø§Ø³ÙŠ
  const q = parseInt(newQty); const p = parseFloat(newPrice);
  if(isNaN(q) || isNaN(p) || q<=0 || p<0){ alert('Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù„Ù„ÙƒÙ…ÙŠØ© Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø±'); return; }
  op.type = newType; op.item = newItem; op.quantity = q; op.price = p; op.notes = newNotes;
  saveOps(); renderTable(); updateSummary();
}

/* --- Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© (Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„ØµØ§Ø­Ø¨Ù‡Ø§) --- */
function deleteOp(id){
  const op = operations.find(o=>o.id===id);
  if(!op) return;
  if(op.user !== currentUser) return alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
  operations = operations.filter(o=>o.id!==id);
  saveOps(); renderTable(); updateSummary();
}

/* --- Ø¥Ø­ØµØ§Ø¡Ø§Øª ÙˆÙ…Ù„Ø®ØµØ§Øª --- */
function updateSummary(){
  const total = { sell:0, buy:0, expense:0 };
  operations.forEach(op=>{
    const sum = (op.quantity*op.price) || 0;
    if(op.type === 'Ø¨ÙŠØ¹') total.sell += sum;
    else if(op.type === 'Ø´Ø±Ø§Ø¡ Ù…ÙˆØ§Ø¯') total.buy += sum;
    else if(op.type === 'ØµØ±Ù') total.expense += sum;
  });
  const net = total.sell - (total.buy + total.expense);
  document.getElementById('summaryArea').innerHTML = `
    Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: <strong>${formatNumber(total.sell)} Ø¯.Ø¹</strong><br>
    Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯: <strong>${formatNumber(total.buy)} Ø¯.Ø¹</strong><br>
    Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: <strong>${formatNumber(total.expense)} Ø¯.Ø¹</strong><br>
    <strong>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ${formatNumber(net)} Ø¯.Ø¹</strong>
  `;
}

/* --- Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø§Ø±ÙŠØ± (Ø¯Ø§Ù„ÙŠ â€” ÙˆÙŠÙƒÙ„ÙŠ â€” Ù…Ø§Ù†Ø«Ù„ÙŠ) --- */
function prepareAndSendReport(range){
  if(!currentUser) return alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
  const now = new Date();
  let from, to = now;
  if(range === 'daily'){
    from = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0);
  } else if(range === 'weekly'){
    const day = now.getDay(); // 0..6 (Ø§Ù„Ø£Ø­Ø¯=0)
    const diff = day; // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: Ø§Ù„Ø£Ø­Ø¯
    from = new Date(now.getFullYear(), now.getMonth(), now.getDate()-diff, 0,0,0);
  } else if(range === 'monthly'){
    from = new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0);
  } else {
    alert('Ù†Ø·Ø§Ù‚ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'); return;
  }
  const filtered = operations.filter(op=>{
    const d = new Date(op.datetime);
    return d >= from && d <= to;
  });
  if(filtered.length === 0) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø·Ø§Ù‚');
  // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Øµ
  const humanRange = range==='daily'?'Ø§Ù„ÙŠÙˆÙ…ÙŠ': range==='weekly'?'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ':'Ø§Ù„Ø´Ù‡Ø±ÙŠ';
  const dateLabel = (new Date()).toLocaleDateString('ar-EG');
  let message = `ğŸ“‹ ØªÙ‚Ø±ÙŠØ± ${humanRange} (${dateLabel})\n\n`;
  let totalSell=0, totalBuy=0, totalExpense=0;
  filtered.forEach(op=>{
    const sum = (op.quantity*op.price) || 0;
    message += `- ${op.type} | ${op.item} x ${op.quantity} = ${sum} Ø¯.Ø¹ | Ø¨ÙˆØ§Ø³Ø·Ø©: ${op.user}\n`;
    if(op.type==='Ø¨ÙŠØ¹') totalSell+=sum;
    else if(op.type==='Ø´Ø±Ø§Ø¡ Ù…ÙˆØ§Ø¯') totalBuy+=sum;
    else if(op.type==='ØµØ±Ù') totalExpense+=sum;
  });
  const net = totalSell - (totalBuy + totalExpense);
  message += `\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${totalSell} Ø¯.Ø¹\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯: ${totalBuy} Ø¯.Ø¹\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${totalExpense} Ø¯.Ø¹\nØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ${net} Ø¯.Ø¹`;
  // Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ù†ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø±Ù‚Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨. Ù†Ù…Ù†Ø­ Ø®ÙŠØ§Ø± Ø¥Ø±Ø³Ø§Ù„ Ù„Ø±Ù‚Ù… Ø¢Ø®Ø±.
  const sendTo = confirm('Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø±Ù‚Ù…Ùƒ (07702684155)ØŸ Ø§Ø¶ØºØ· "Ø¥Ù„ØºØ§Ø¡" Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¢Ø®Ø±') ? DEFAULT_WHATSAPP : prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¯ÙˆÙ„ÙŠ Ø¨Ø¯ÙˆÙ† Ø²Ø§Ø¦Ø¯ (+)ØŒ Ù…Ø«Ø§Ù„: 9647702684155');
  if(!sendTo) return;
  const waLink = `https://wa.me/${sendTo}?text=${encodeURIComponent(message)}`;
  window.open(waLink, '_blank');
}

/* --- ØªØµØ¯ÙŠØ± CSV --- */
function exportCSV(){
  if(operations.length===0) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
  const rows = [['id','datetime','user','type','item','quantity','price','sum','notes']];
  operations.forEach(op=>{
    const sum = (op.quantity*op.price) || 0;
    rows.push([op.id, op.datetime, op.user, op.type, op.item, op.quantity, op.price, sum, (op.notes||'')]);
  });
  const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'kado-operations.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* --- Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ø­Ø°Ø±) --- */
function clearAll(){
  if(!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
  operations = [];
  saveOps();
  renderTable();
  updateSummary();
  alert('ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
}

/* --- Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© --- */
document.addEventListener('DOMContentLoaded', ()=>{
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©ØŒ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§. Ø³Ù†Ø¹Ø±Ø¶Ù‡Ø§ ÙÙ‚Ø· Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.
  renderTable();
  updateSummary();
});

/* --- Ù…Ø³Ø§Ø¹Ø¯Ø© Ø±Ù‚Ù…ÙŠØ©: Ù‡Ø±ÙˆØ¨ Ø¨Ø³ÙŠØ· Ù„Ù„Ø®Ø·Ø± XSS Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ prompt --- */
window.escapeHtml = escapeHtml;
</script>

</body>
</html>
